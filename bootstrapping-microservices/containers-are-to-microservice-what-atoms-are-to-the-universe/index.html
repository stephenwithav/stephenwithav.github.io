<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Containers:Microservices :: Atoms:Universes | Steven&#39;s Thoughts</title>
<meta name="title" content="Containers:Microservices :: Atoms:Universes" />
<meta name="description" content="
Containers are to Microservices what Atoms are to Universes.  What in the world does that mean, you ask?

Universes are composed of many Atoms.  Likewise, Microservices are composed of many Containers.

We containerized our video-streaming endpoint last week.  This week we will decouple video-streaming from its underlying storage mechanism by adding a video-storage microservice, which will be backed by an S3-compatible storage system.

But first, let&#39;s use our earlier video-streaming Docker container from last week to learn docker compose." />
<meta name="author" content="" />
<meta name="keywords" content="microservices,docker,S3,MinIO,MongoDB," />






  
  <meta property="og:url" content="https://example.org/bootstrapping-microservices/containers-are-to-microservice-what-atoms-are-to-the-universe/">
  <meta property="og:site_name" content="Steven&#39;s Thoughts">
  <meta property="og:title" content="Containers:Microservices :: Atoms:Universes">
  <meta property="og:description" content=" Containers are to Microservices what Atoms are to Universes. What in the world does that mean, you ask?
Universes are composed of many Atoms. Likewise, Microservices are composed of many Containers.
We containerized our video-streaming endpoint last week. This week we will decouple video-streaming from its underlying storage mechanism by adding a video-storage microservice, which will be backed by an S3-compatible storage system.
But first, let&#39;s use our earlier video-streaming Docker container from last week to learn docker compose.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="bootstrapping-microservices">
    <meta property="article:published_time" content="2024-09-25T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-09-25T00:00:00+00:00">
    <meta property="article:tag" content="Microservices">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="S3">
    <meta property="article:tag" content="MinIO">
    <meta property="article:tag" content="MongoDB">
        <meta property="fb:admins" content="stephenwithav">


  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Containers:Microservices :: Atoms:Universes">
  <meta name="twitter:description" content=" Containers are to Microservices what Atoms are to Universes. What in the world does that mean, you ask?
Universes are composed of many Atoms. Likewise, Microservices are composed of many Containers.
We containerized our video-streaming endpoint last week. This week we will decouple video-streaming from its underlying storage mechanism by adding a video-storage microservice, which will be backed by an S3-compatible storage system.
But first, let&#39;s use our earlier video-streaming Docker container from last week to learn docker compose.">
      <meta name="twitter:site" content="@stephenwithavee">


  
  
  <meta itemprop="name" content="Containers:Microservices :: Atoms:Universes">
  <meta itemprop="description" content=" Containers are to Microservices what Atoms are to Universes. What in the world does that mean, you ask?
Universes are composed of many Atoms. Likewise, Microservices are composed of many Containers.
We containerized our video-streaming endpoint last week. This week we will decouple video-streaming from its underlying storage mechanism by adding a video-storage microservice, which will be backed by an S3-compatible storage system.
But first, let&#39;s use our earlier video-streaming Docker container from last week to learn docker compose.">
  <meta itemprop="datePublished" content="2024-09-25T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-09-25T00:00:00+00:00">
  <meta itemprop="wordCount" content="2149">
  <meta itemprop="keywords" content="Microservices,Docker,S3,MinIO,MongoDB">

<meta name="referrer" content="no-referrer-when-downgrade" />

  
  <link href="/original.min.css" rel="stylesheet">

  

  

  
</head>

<body>
  <header><a class="skip-link" href="#main-content">Skip to main content</a>

<a href="/" class="title"><h1>Steven&#39;s Thoughts</h1></a>
<nav>
  <a href="/about">About</a>

<a href='https://example.org/index.xml'>RSS</a>







</nav>
</header>
  <main id="main-content"> 
<h1>Containers:Microservices :: Atoms:Universes</h1>
<p class="byline">
  <time datetime='2024-09-25' pubdate>
    2024-09-25
  </time>
  
</p>

<content>
  
<p>
Containers are to Microservices what Atoms are to Universes.  What in the world does that mean, you ask?</p>
<p>
Universes are <em>composed</em> of many Atoms.  Likewise, Microservices are <em>composed</em> of many Containers.</p>
<p>
We containerized our <code class="verbatim">video-streaming</code> endpoint last week.  This week we will decouple <code class="verbatim">video-streaming</code> from its underlying storage mechanism by adding a <code class="verbatim">video-storage</code> microservice, which will be backed by an <code class="verbatim">S3</code>-compatible storage system.</p>
<p>
But first, let&#39;s use our earlier <code class="verbatim">video-streaming</code> Docker container from <a href="/bootstrapping-microservices/docker-and-containers-and-minikube-oh-my/">last week</a> to learn <code class="verbatim">docker compose</code>.</p>
<div id="outline-container-headline-1" class="outline-3">
<h3 id="headline-1">
Round 1: <code class="verbatim">docker compose</code>. (<a href="https://github.com/Bootstrapping-Microservices-in-Go/chapter-04/tree/main/example-1">source</a>)
</h3>
<div id="outline-text-headline-1" class="outline-text-3">
<p>Last week we learned to create a <code class="verbatim">Dockerfile</code> that allows us to create and easily deploy our <code class="verbatim">video-streaming</code> microservice anywhere.</p>
<p>
We used the Docker CLI with several flags to specify the required environment variable (<code class="verbatim">-e</code>) and mapped port 4000 on our local computer to port 80 (<code class="verbatim">-p 4000:80</code>) in our container.  Remembering the relevant flags and the required container creation order, especially when connecting containers and their associated dependencies is difficult if not impossible.</p>
<p>
Thankfully, <code class="verbatim">docker compose</code> comes to our rescue.  <code class="verbatim">docker-compose.yaml</code> (or <code class="verbatim">docker-compose.yml</code>) allows us to express dependencies between containers so we can define the configuration once and forget it.  The declarative nature of the <code class="verbatim">docker-compose.yml</code> file simplifies both deployment and testing.  (Testing will be covered in a few weeks.)</p>
<div class="src src-yaml">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># Version isn&#39;t required as of Docker 3.9, but old habits die hard.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Our service name is video-streaming.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">video-streaming</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># It creates an image named video-streaming...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">video-streaming</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ...from the Dockerfile in the ./video-streaming subdirectory.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./video-streaming</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">dockerfile</span>: <span style="color:#ae81ff">Dockerfile</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The container&#39;s image name is also video-streaming,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># although it doesn&#39;t have to be.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">video-streaming</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Here we map our host port 4000 to the container port 80.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;4000:80&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Here we specify the environment variables our microservice</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># depends on.  We only need PORT for now.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">PORT=80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Do we want to restart the container if it fails?</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Not during development.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#e6db74">&#34;no&#34;</span></span></span></code></pre></div>
</div>
<p>
With our <code class="verbatim">docker-compose.yaml</code> file defined, and our microservice from last week moved to the <code class="verbatim">./video-streaming</code> subdirectory, we can now start our first microservice.  (A single Atom Universe!)</p>
<div class="src src-sh">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker compose up</span></span></code></pre></div>
</div>
<p>
We verify our microservice is running with the following:</p>
<div class="src src-sh">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker compose ps</span></span></code></pre></div>
</div>
<p>
And we can shut it down with:</p>
<div class="src src-sh">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ docker compose down</span></span></code></pre></div>
</div>
<p>
Personally, I like having the <code class="verbatim">dc</code> alias (for Linux and Macs) as follows:</p>
<div class="src src-sh">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>alias dc<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;docker compose&#39;</span></span></span></code></pre></div>
</div>
<p>
This makes it easy to quickly <code class="verbatim">dc up</code>, <code class="verbatim">dc ps</code>, and <code class="verbatim">dc down</code> as needed.</p>
</div>
</div>
<div id="outline-container-headline-2" class="outline-3">
<h3 id="headline-2">
Round 2: <code class="verbatim">S3</code>, <code class="verbatim">MinIO</code>, and the <code class="verbatim">video-storage</code> microservice. (<a href="https://github.com/Bootstrapping-Microservices-in-Go/chapter-04/tree/main/example-2">source</a>)
</h3>
<div id="outline-text-headline-2" class="outline-text-3">
<p>Atoms need to interact with other Atoms to make the Universe fun, so let&#39;s add our second Atom: <code class="verbatim">video-storage</code>.</p>
<p>
Our first container from last week has one major flaw: the sample video was mounted directly from the local file system into the <code class="verbatim">video-streaming</code> Docker image.  This restriction would force our files to be copied to every machine running the container, which wouldn&#39;t be very efficient.</p>
<p>
Another option, the one we&#39;ll use, is to host our files in the magical cloud and make them accessible via HTTP.  Amazon&#39;s <code class="verbatim">S3</code> service fits this description, allowing us to place files into <code class="verbatim">Buckets</code> and retrieve them via HTTP, so we&#39;ll use it.</p>
<p>
But, we think, do we <em>really</em> want to pay for <code class="verbatim">S3</code> while we&#39;re still in the learning phase?  Not really.  Life happens and we may get distracted, leaving us paying a bill for something that&#39;s not providing us value.</p>
<p>
This is where <code class="verbatim">MinIO</code> enters the picture.  <code class="verbatim">MinIO</code> is an <code class="verbatim">S3</code>-compatible file system that runs in a local Docker container; <code class="verbatim">MinIO</code> lets you learn at your own pace for zero cost.</p>
<div id="outline-container-headline-3" class="outline-4">
<h4 id="headline-3">
MinIO Basics
</h4>
<div id="outline-text-headline-3" class="outline-text-4">
<p>Docker offers the simplest and most straight-forward way to launch <code class="verbatim">MinIO</code>, so let&#39;s append it to our earlier <code class="verbatim">docker-compose.yaml</code> file.</p>
<div class="src src-yaml">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#75715e"># MinIO is our service name.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minio</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># We use the bitnami image for easier configuration.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">docker.io/bitnami/minio:latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">minio</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># MinIO can be used with secret keys or a username</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># and password.  The former will be covered in future</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># weeks, so let&#39;s stick with username/password for now.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">MINIO_ROOT_USER=steven</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">MINIO_ROOT_PASSWORD=changeme</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># MINIO_DEFAULT_BUCKETS creates non-existant buckets for us.</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">MINIO_DEFAULT_BUCKETS=videos</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Don&#39;t restart on error so we know something went wrong.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#e6db74">&#34;no&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Port 9000 is MinIO&#39;s default service port.</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;9000:9000&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Port 9001 is for MinIO&#39;s web interface.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># We login with the MINIO_ROOT_USER and</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># MINIO_ROOT_PASSWORD defined above.</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;9001:9001&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># MinIO stores data in /bitmap/minio/data, at least</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># in this image.  We&#39;ll overlay our ./data directory</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># there so every Bucket change persists locally.</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./data:/bitnami/minio/data</span></span></span></code></pre></div>
</div>
<p>
Starting the services with <code class="verbatim">dc up --build</code> (after <code class="verbatim">dc down --volumes</code> if you launched the first one) enables <code class="verbatim">MinIO</code>&#39;s web interface at <code class="verbatim">http://localhost:9001/</code>.</p>
<p>
This round requires the sample video file to be placed in the <code class="verbatim">videos</code> <code class="verbatim">Bucket</code> we created earlier, so:</p>
<ol>
<li>Start the microservice with <code class="verbatim">dc up --build</code>.</li>
<li>Login to the <a href="http://localhost:9001/">web interface</a> with the values you chose for <code class="verbatim">MINIO_ROOT_USER</code> and <code class="verbatim">MINIO_ROOT_PASSWORD</code>.</li>
<li>Click <code class="verbatim">Object Browser</code> on the left under User.</li>
<li>Click the <code class="verbatim">videos</code> folder.</li>
<li>Click <code class="verbatim">Upload</code>, then <code class="verbatim">Upload File</code>.</li>
<li>Select the sample video to upload it.</li>
</ol>
<p>Congrats on making it this far!  Next: the <code class="verbatim">video-storage</code> microservice!</p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-4">
<h4 id="headline-4">
<code class="verbatim">video-storage</code>
</h4>
<div id="outline-text-headline-4" class="outline-text-4">
<p>Our <code class="verbatim">video-storage</code> microservice relies on <strong><strong>six</strong></strong> environment variables to function, so we&#39;re going to make a helper func that will either retrieve those variables or kill the program with an error telling us which variable needs to be set.</p>
<p>
Then we&#39;ll connect to <code class="verbatim">S3=/=MinIO</code> and create an HTTP endpoint that can stream the file to the recipient (browser or another microservice) upon request.</p>
<p>
See below:</p>
<div class="src src-go">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log/slog&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/aws/aws-sdk-go-v2/aws&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/aws/aws-sdk-go-v2/credentials&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/aws/aws-sdk-go-v2/service/s3&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// If the requested environment variable is missing, fail with
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// the given error message.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#a6e22e">variableName</span>, <span style="color:#a6e22e">failureMessage</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">found</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">LookupEnv</span>(<span style="color:#a6e22e">variableName</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">found</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">failureMessage</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">value</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Retrieve the required environment variables.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#e6db74">`PORT`</span>, <span style="color:#e6db74">`Please specify the port number for the HTTP server with the environment variable PORT.`</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">minioStorageHost</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#e6db74">`MINIO_STORAGE_HOST`</span>, <span style="color:#e6db74">`Please specify the name for the storage host in the variable MINIO_STORAGE_HOST.`</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">minioStoragePort</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#e6db74">`MINIO_STORAGE_PORT`</span>, <span style="color:#e6db74">`Please specify the port number for the storage host with the environment variable MINIO_STORAGE_PORT.`</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bucketName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#e6db74">&#34;BUCKET&#34;</span>, <span style="color:#e6db74">`Please specify the S3 bucket name in the environment variable BUCKET.`</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">minioUser</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#e6db74">`MINIO_ROOT_USER`</span>, <span style="color:#e6db74">`Please specify the S3 user name in the environment variable MINIO_ROOT_USER.`</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">minioPassword</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#e6db74">`MINIO_ROOT_PASSWORD`</span>, <span style="color:#e6db74">`Please specify the S3 password in the environment variable MINIO_ROOT_PASSWORD.`</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Define our S3/MinIO endpoint.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">minioEndpoint</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">`%s:%s`</span>, <span style="color:#a6e22e">minioStorageHost</span>, <span style="color:#a6e22e">minioStoragePort</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Default for now.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">awsRegion</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;us-east-1&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// A CredentialsProvider is required to login to S3/MinIO.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">credProvider</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">NewCredentialsCache</span>(
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">credentials</span>.<span style="color:#a6e22e">NewStaticCredentialsProvider</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">minioUser</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">minioPassword</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#e6db74">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// BaseEndpoint and UsePathStyle are the most important variables here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// BaseEndpoint is your localhost:port.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// UsePathStyle lets you access files like they&#39;re in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// a filesystem.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// s3.New returns a client that can retrieve and store
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// files in S3.  For now, we only care about retrieval.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s3svc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s3</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">s3</span>.<span style="color:#a6e22e">Options</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Credentials</span>:  <span style="color:#a6e22e">credProvider</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Region</span>:       <span style="color:#a6e22e">awsRegion</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">BaseEndpoint</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">minioEndpoint</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">UsePathStyle</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mux</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServeMux</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;GET /video&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Extract the path value.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">path</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">`path`</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">input</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s3</span>.<span style="color:#a6e22e">GetObjectInput</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Bucket</span>: <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">bucketName</span>),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Key</span>:    <span style="color:#a6e22e">aws</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">path</span>),
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Retrieve the object from S3...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">result</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s3svc</span>.<span style="color:#a6e22e">GetObject</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">input</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...or not.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusNotFound</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">Body</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">slog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">`video-storage online`</span>, <span style="color:#e6db74">`port`</span>, <span style="color:#a6e22e">port</span>, <span style="color:#e6db74">`bucketName`</span>, <span style="color:#a6e22e">bucketName</span>, <span style="color:#e6db74">`host`</span>, <span style="color:#a6e22e">minioEndpoint</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprint</span>(<span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">port</span>), <span style="color:#a6e22e">mux</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
</div>
<p>
With the <code class="verbatim">video-storage</code> microservice defined, let&#39;s now add it to our <code class="verbatim">docker-compose.yml</code> file.</p>
<div class="src src-dockerfile">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span>  video-storage:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    build:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      context: ./video-storage<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      dockerfile: Dockerfile<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    environment:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - BUCKET<span style="color:#f92672">=</span>videos<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - MINIO_ROOT_USER<span style="color:#f92672">=</span>steven<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - MINIO_ROOT_PASSWORD<span style="color:#f92672">=</span>changeme<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - MINIO_STORAGE_HOST<span style="color:#f92672">=</span>http://minio<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - MINIO_STORAGE_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">9000</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;4001:80&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    restart: <span style="color:#e6db74">&#34;no&#34;</span></span></span></code></pre></div>
</div>
<p>
Now we&#39;re ALMOST complete.</p>
<p>
The <code class="verbatim">video-streaming</code> microservice from Round 1 still stores the sample <code class="verbatim">.mp4</code> in its own image.  Let&#39;s now remove that responsibility from <code class="verbatim">video-streaming</code> and delegate it to where it belongs: <code class="verbatim">video-storage</code>!</p>
<div class="src src-go">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log/slog&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#a6e22e">variableName</span>, <span style="color:#a6e22e">failureMessage</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">found</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">LookupEnv</span>(<span style="color:#a6e22e">variableName</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">found</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">failureMessage</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">value</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#e6db74">`PORT`</span>, <span style="color:#e6db74">`Please specify the port number for the HTTP server with the environment variable PORT.`</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The host is minio.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">videoStorageHost</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#e6db74">`VIDEO_STORAGE_HOST`</span>, <span style="color:#e6db74">`Please specify the video storage host name with the environment variable VIDEO_STORAGE_HOST.`</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// The REST port is 9000.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">videoStoragePort</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">failOnMissingEnvironmentVariable</span>(<span style="color:#e6db74">`VIDEO_STORAGE_PORT`</span>, <span style="color:#e6db74">`Please specify the video storage port number with the environment variable VIDEO_STORAGE_PORT.`</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mux</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServeMux</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;GET /video&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">videoPath</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;/video?path=SampleVideo_1280x720_1mb.mp4&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">videoStorageURL</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">`%s:%s%s`</span>, <span style="color:#a6e22e">videoStorageHost</span>, <span style="color:#a6e22e">videoStoragePort</span>, <span style="color:#a6e22e">videoPath</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>, <span style="color:#a6e22e">videoStorageURL</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Header</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Retrieve videoStorageURL.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">DefaultClient</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// This error check alone won&#39;t check for 404s, unfortunately.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusFailedDependency</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;couldn&#39;t retrieve %s from %s&#34;</span>, <span style="color:#a6e22e">videoPath</span>, <span style="color:#a6e22e">videoStorageHost</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">contentType</span>, <span style="color:#e6db74">&#34;video/mp4&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">slog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">`video-storage online`</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprint</span>(<span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#a6e22e">port</span>), <span style="color:#a6e22e">mux</span>)
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
</div>
<p>
One <code class="verbatim">dc down --volumes</code> and <code class="verbatim">dc up --build</code> later and you&#39;re <em>finally</em> ready to see your results.  (Atoms two and three, <code class="verbatim">MinIO</code> and <code class="verbatim">video-storage</code>, make our Universe much cleaner.)</p>
<p>
We can even test our <code class="verbatim">video-storage</code> microservice individually by, based on the port mappings in our <code class="verbatim">docker-compose.yml</code> file, visiting <a href="http://localhost:4001/video?path=SampleVideo_1280x720_1mb.mp4">localhost:4001</a>.</p>
<p>
Next?  Even more excitement!  We&#39;re about to add a fourth Atom to our Universe: a database to map those filenames to YouTube-like query strings.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
Round 3: <code class="verbatim">MongoDB</code> for the win! (<a href="https://github.com/Bootstrapping-Microservices-in-Go/chapter-04/tree/main/example-3">source</a>)
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<p>Which of the following URL paths do you prefer?</p>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>1. /video?path=SampleVideo_1280x720_1mb.mp4
</span></span><span style="display:flex;"><span>2. /video?id=5d9e690ad76fe06a3d7ae416</span></span></code></pre></div>
</div>
<p>
You are in good company if you chose number 2!  So that&#39;s what we&#39;ll do.</p>
<p>
We will need a database collection mapping the <code class="verbatim">id</code> parameter we&#39;ll retrieve in <code class="verbatim">video-streaming</code> to the <code class="verbatim">path</code> parameter expected in the <code class="verbatim">video-storage</code> microservice, so let&#39;s add <code class="verbatim">MongoDB</code> to our <code class="verbatim">docker-compose.yml</code>:</p>
<div class="src src-yaml">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">db</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mongo:7</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">db</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;4000:27017&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">minio</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./db-fixtures:/fixtures</span></span></span></code></pre></div>
</div>
<p>
Next we need to update <code class="verbatim">video-streaming</code> to retrieve the filename from <code class="verbatim">MongoDB</code> before we can ask <code class="verbatim">video-storage</code> to send us some of those sweet, sweet bytes its storing.</p>
<p>
Fortunately, the changes required to <code class="verbatim">video-streaming</code> here are largely cosmetic.  We simply retrieve the <code class="verbatim">videoPath</code> from the <code class="verbatim">MongoDB</code> database instead of hard-coding it, then we request it from the <code class="verbatim">video-storage</code> microservice along and forward the request headers.</p>
<p>
Compare the <code class="verbatim">http.HandlerFunc</code> from Round 2</p>
<div class="src src-go">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;GET /video&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">videoPath</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;/video?path=SampleVideo_1280x720_1mb.mp4&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">videoStorageURL</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">`%s:%s%s`</span>, <span style="color:#a6e22e">videoStorageHost</span>, <span style="color:#a6e22e">videoStoragePort</span>, <span style="color:#a6e22e">videoPath</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>, <span style="color:#a6e22e">videoStorageURL</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Header</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">DefaultClient</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusFailedDependency</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;couldn&#39;t retrieve %s from %s&#34;</span>, <span style="color:#a6e22e">videoPath</span>, <span style="color:#a6e22e">videoStorageHost</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">contentType</span>, <span style="color:#e6db74">&#34;video/mp4&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>)
</span></span><span style="display:flex;"><span>	})</span></span></code></pre></div>
</div>
<p>
with the one from this Round:</p>
<div class="src src-go">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;GET /video&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">videoPath</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getPathFromObjectID</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">FormValue</span>(<span style="color:#e6db74">`id`</span>), <span style="color:#a6e22e">collection</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">videoPath</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">slog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">`video-storage`</span>, <span style="color:#e6db74">`id`</span>, <span style="color:#e6db74">`not found`</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusNotFound</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">videoStorageURL</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s:%s/video?id=%s&#34;</span>, <span style="color:#a6e22e">videoStorageHost</span>, <span style="color:#a6e22e">videoStoragePort</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">videoPath</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>, <span style="color:#a6e22e">videoStorageURL</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Header</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Retrieve videoStorageURL.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">DefaultClient</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">req</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// This error check alone won&#39;t check for 404s, so we need to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// ensure we fail on any non-OK response.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">StatusCode</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">slog</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">`video-storage`</span>, <span style="color:#e6db74">`retrieval error`</span>, <span style="color:#a6e22e">err</span>, <span style="color:#e6db74">`url`</span>, <span style="color:#a6e22e">videoStorageURL</span>, <span style="color:#e6db74">`addr`</span>, <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">RemoteAddr</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusFailedDependency</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">contentType</span>, <span style="color:#e6db74">&#34;video/mp4&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Copy</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">resp</span>.<span style="color:#a6e22e">Body</span>)
</span></span><span style="display:flex;"><span>	})</span></span></code></pre></div>
</div>
<p>
The two handler functions are identical except for the <code class="verbatim">nil</code>-check and the call to the <code class="verbatim">getPathFromObjectID</code> helper function, which executes the <code class="verbatim">MongoDB</code> query when the <code class="verbatim">id</code> field isn&#39;t empty.</p>
<p>
There&#39;s seven additional lines of <code class="verbatim">MongoDB</code> client initialization code as well, but the two are functionally indistinguishable.</p>
</div>
</div>
<div id="outline-container-headline-6" class="outline-3">
<h3 id="headline-6">
Errata
</h3>
<div id="outline-text-headline-6" class="outline-text-3">
<p>This week&#39;s code was complicated by my old-fashioned development approach and solved by <a href="https://www.linkedin.com/in/ashleydavis75/">Ashley Davis&#39;s</a> wisdom from the <a href="https://bootstrapping-microservices.com/">Bootstrapping Microservices</a> book: run the service outside of <code class="verbatim">docker-compose</code> when developing and use live-reload.</p>
<p>
I wasted a lot of time Sunday and Monday tweaking the code, adding logging here and there, then waiting for <code class="verbatim">dc down --volumes &amp;&amp; dc up --build</code> to run, then loading the sample data into <code class="verbatim">MongoDB</code> with <code class="verbatim">mongoimport --database videos --collection videos --file ./fixtures/videos.json</code>, and finally testing the endpoints for both <code class="verbatim">video-streaming</code> and <code class="verbatim">video-storage</code> to no avail.</p>
<p>
I woke up yesterday morning with the following thoughts:</p>
<ol>
<li><code class="verbatim">video-storage</code> only depends on the <code class="verbatim">mongo</code> microservice.</li>
<li><code class="verbatim">mongo</code> exposes its port <code class="verbatim">9000</code> locally, so I can connect to it locally.</li>
<li><code class="verbatim">emacs</code> has a <code class="verbatim">Postman</code> equivalent called <a href="https://github.com/pashky/restclient.el">restclient</a> that allows developers to test endpoints directly from inside emacs.</li>
<li>Load a <code class="verbatim">tmux</code> session with 3 panes: the first running <code class="verbatim">air</code> in the <code class="verbatim">video-storage</code> microservice (with tons of logging), the second holding the actual Go code to edit in emacs, and the third running restclient in another emacs window.</li>
</ol>
<p>With the help of <code class="verbatim">air</code>, I was able to quickly iterate on the code, let the service reload independently, and run the HTTP tests in emacs.</p>
<div class="src src-sh">
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">5000</span> MINIO_ROOT_USER<span style="color:#f92672">=</span>steven MINIO_ROOT_PASSWORD<span style="color:#f92672">=</span>changeme MINIO_STORAGE_HOST<span style="color:#f92672">=</span>http://localhost MINIO_STORAGE_PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">9000</span> BUCKET<span style="color:#f92672">=</span>videos air</span></span></code></pre></div>
</div>
<p>
After an hour of iterating and testing, I realized the <code class="verbatim">slog</code> messages lacked the actual error message.  Adding those fields showed my code wasn&#39;t wrong, my configuration was.</p>
<p>
<code class="verbatim">MINIO_STORAGE_HOST</code> was set to <code class="verbatim">mongodb://minio</code> instead of <code class="verbatim">http://minio</code>.</p>
<p>
Boy did I feel stupid. :)</p>
</div>
</div>
<div id="outline-container-headline-7" class="outline-3">
<h3 id="headline-7">
Addendum
</h3>
<div id="outline-text-headline-7" class="outline-text-3">
<p><code class="verbatim">docker-compose</code> and <code class="verbatim">Kubernetes</code> always remind me of the <a href="https://www.youtube.com/watch?v=OiYjTb3opAA">Captain Planet</a> theme song.  <em>By your containers combined!</em></p>
<p>
<em>By your containers composed!</em> maybe?</p>
</div>
</div>

</content>
<p>
  
  <a class="blog-tags" href="/tags/microservices/">#microservices</a>
  
  <a class="blog-tags" href="/tags/docker/">#docker</a>
  
  <a class="blog-tags" href="/tags/s3/">#s3</a>
  
  <a class="blog-tags" href="/tags/minio/">#minio</a>
  
  <a class="blog-tags" href="/tags/mongodb/">#mongodb</a>
  
</p>
   
  </main>
  <footer><small>
   Steven Edwards | made with Emacs
</small></footer>

    
</body>

</html>
